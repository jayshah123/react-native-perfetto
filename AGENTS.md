# AGENTS.md

Guidance for coding agents working on `react-native-perfetto`.

## Goal

This repository provides a React Native tracing library backed by a shared C++ core and TurboModule bridges on Android and iOS.
The public API is session-first (`startRecording` -> `TraceSession`) with optional compatibility wrappers.

## High-level architecture

- Public JS/TS API: `src/index.tsx`
- TurboModule spec: `src/NativePerfetto.ts`
- Shared tracer core: `cpp/ReactNativePerfettoTracer.h`, `cpp/ReactNativePerfettoTracer.cpp`
- Android bridge:
  - Kotlin module: `android/src/main/java/com/perfetto/PerfettoModule.kt`
  - JNI bridge: `android/src/main/jni/reactnativeperfetto-jni.cpp`
  - CMake: `android/CMakeLists.txt`
- iOS bridge:
  - Module interface: `ios/Perfetto.h`
  - ObjC++ implementation: `ios/Perfetto.mm`

## Perfetto SDK behavior

- Full recording support requires vendored SDK files:
  - `cpp/third_party/perfetto/sdk/perfetto.h`
  - `cpp/third_party/perfetto/sdk/perfetto.cc`
  - Quick vendor command: `yarn vendor:perfetto-sdk`
- If SDK files are absent:
  - section/event/counter APIs still work through platform facilities.
  - `startRecording` and `TraceSession.stop()` intentionally return errors.

## Engineering rules

- Keep JS API backward compatible when possible.
- Prefer `withSection`/`withRecording` and explicit `try/finally` lifecycle patterns in examples/docs.
- Keep Android and iOS behavior aligned for method semantics and errors.
- Prefer implementing core logic in C++ and keep platform bridges thin.
- Do not add app-level New Architecture hooks that require host app manual edits.
- Keep C++ changes portable across Android and iOS.

## Adding new API methods

1. Update `src/NativePerfetto.ts` first.
2. Update JS wrapper in `src/index.tsx`.
3. Implement Android in `PerfettoModule.kt` and JNI if native needed.
4. Implement iOS in `Perfetto.mm`.
5. Implement/extend C++ core.
6. Update example app usage in `example/src/App.tsx`.
7. Document behavior in `README.md`.

## Build and validation commands

- Install dependencies: `yarn`
- Type check: `yarn typecheck`
- Lint: `yarn lint`
- Build JS artifacts: `yarn prepare`
- Run example Android: `yarn example android`
- Run example iOS: `yarn example ios`
- Install Maestro CLI: `yarn maestro:install`
- Run Maestro capture flow: `yarn maestro:test:capture-trace`

## Common pitfalls

- Mismatch between TS spec and platform method signatures will break codegen/build.
- C++ source location must remain under `cpp/` for Podspec + CMake wiring.
- iOS Promise methods must use `resolve`/`reject` signatures generated by codegen.
- Android JNI method names must match Kotlin `external` method signatures exactly.
